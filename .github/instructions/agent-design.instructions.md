# Agent Workflow Design Instructions

このドキュメントは、新しいエージェントやワークフローを設計・実装する際のガイドラインです。
堅牢で保守性の高い自律エージェントシステムを構築するために、以下の原則に従ってください。

---

## Part 1: エージェント設計原則

### 1. 単一責任の原則 (Single Responsibility)

- **1 エージェント・1 ゴール**: 1 つのエージェント（`.agent.md`）には、明確に定義された 1 つの役割を与えてください。
- **役割の分離**: 「計画」「実装」「レビュー」「テスト」などのフェーズごとにエージェントを分けることを検討してください。これにより、コンテキストあふれを防ぎ、各ステップの品質を担保できます。

### 2. ステートレスと冪等性 (Stateless & Idempotency)

- **コンテキスト依存の排除**: エージェントは、過去の会話履歴（メモリ）だけに頼らず、常にファイルシステムや Issue の現状（State）を見て判断するように設計してください。
- **再実行可能性**: ワークフローが途中で失敗しても、最初から（または途中から）再実行すれば正しい状態に収束するように設計してください（冪等性）。
  - 例: 「ファイルに追記する」ではなく「ファイルの内容を確認し、足りなければ追記する」ロジックにする。

### 3. オーケストレーション (Orchestration)

- **階層構造**: 複雑なタスクは「マネージャーエージェント」が計画を立て、「ワーカーエージェント」に `runSubagent` で委譲する構成を推奨します。
- **明確なハンドオフ**: エージェント間でタスクを受け渡す際は、期待する成果物（ファイルパス、フォーマット、完了条件）を明確に定義してください。

### 4. フェイルセーフと人間による確認 (Fail-safe & Human-in-the-loop)

- **破壊的操作のガード**: ファイル削除や強制上書き (`--force`)、外部へのデプロイなど、取り返しのつかない操作の前には必ず人間に確認を求めるか、別の検証ステップを挟んでください。
- **エラーハンドリング**: ツール実行エラーが発生した場合、単に停止するのではなく、エラーログを読み、修正を試みるか、人間に助けを求めるようにプロンプトを設計してください。

### 5. 可観測性 (Observability)

- **ログと痕跡**: エージェントの思考プロセスや決定事項は、チャットログだけでなく、Issue のコメントや `docs/` 配下のドキュメントとして残るようにしてください。
- **進捗の可視化**: 長時間のタスクでは、定期的に現状（Todo リストの消化状況など）を報告させてください。

---

## Part 2: ワークフローアーキテクチャ原則

複数エージェント・ツール・スクリプトが協調して動作するワークフロー全体の設計指針です。

### 6. 二段階アーキテクチャ (Input → IR → Output)

すべてのエージェントワークフローは、以下の構造に統一してください：

```
入力 (Input) → 中間表現 (IR) → 最終成果物 (Output)
```

- **生成フェーズ**: エージェントはまず **構造化された中間表現（IR: Intermediate Representation）** を生成する。
- **変換フェーズ**: 最終成果物は IR のみを参照して忠実に生成する。
- **利点**: 入出力の揺れを減らし、安定性・再現性を高める。

### 7. 中間表現（IR）の仕様化

IR は「制約付きフォーマット」として厳密に仕様化してください：

- **許可する構造**: 使用できるキー・タグ・構造を明確に定める（JSON / YAML / 構造化 Markdown など）。
- **曖昧さの排除**: 自由形式の自然言語は許可しない。
- **厳格なバリデーション**: IR が不正ならエラーを返し、勝手に補完・推測しない。

```yaml
# IR の例（タスク定義）
task:
  id: "task-001"
  type: "implementation"
  input:
    file: "src/handler.ts"
    description: "エラーハンドリングを追加"
  output:
    file: "src/handler.ts"
    validation: "lint-pass"
```

### 8. 責務の厳密な分離

エージェント・ツール・スクリプトの責務を以下の 5 つに分類し、混在させないでください：

| 責務          | 説明                  | 例                   |
| ------------- | --------------------- | -------------------- |
| **Generate**  | IR を生成する         | 計画エージェント     |
| **Parse**     | 入力を解析する        | 入力バリデータ       |
| **Validate**  | IR や成果物を検証する | スキーマチェッカー   |
| **Transform** | IR を成果物に変換する | コード生成スクリプト |
| **Render**    | 最終形式に出力する    | Markdown → PDF 変換  |

```
[生成エージェント] → IR → [検証ツール] → [変換スクリプト] → 成果物
```

### 9. 決定性の保証 (Determinism)

変換処理は常に決定的（deterministic）であること：

- **同じ IR → 同じ成果物**: IR が同一なら、常に同じ結果を生成する。
- **創作の禁止**: レイアウト調整・推測・補完などの"創作"は変換フェーズで行わない。
- **不確実性の閉じ込め**: 不確実性は生成フェーズに限定し、変換フェーズでは排除する。

### 10. バリデーションの強化

ワークフロー全体で以下のバリデーションを必須とする：

- **IR の構文チェック**: スキーマに準拠しているか
- **入出力の整合性**: 期待する形式と一致しているか
- **環境依存の検証**: パス・設定値が存在するか
- **明確なエラーメッセージ**: 曖昧な状態でワークフローを進めない

### 11. ロギングとデバッグ性

- **IR の保存**: 中間表現は必ずログとして保存する（`logs/` や Issue コメント等）。
- **トレーサビリティ**: ワークフロー失敗時に「どの段階で何が原因だったか」を追跡可能にする。
- **段階ごとの出力**: 各フェーズの入出力を記録する。

### 12. 環境非依存の設計

- **抽象化**: ファイル名やプロジェクト固有のパスに依存しない設計にする。
- **設定の外部化**: 環境変数や共通設定ファイル（`.env`, `config.yaml`）で統一する。
- **相対パスの活用**: ワークスペースルートからの相対パスを使用する。

### 13. 拡張性の確保

- **フォーマット追加が容易**: Markdown → HTML → スライド → PDF など、新形式を後付けできる構造にする。
- **IR 中心設計**: IR を中心に据えることで、多数のレンダラーを追加可能にする。

```
        ┌─→ [HTML Renderer] → HTML
IR ─────┼─→ [PDF Renderer]  → PDF
        └─→ [Slide Renderer] → PPTX
```

---

## エージェントマニフェスト (`.agent.md`) の必須項目

新しいエージェントを定義する際は、以下を含めてください：

1. **Role**: 何をするエージェントか（Persona）。
2. **Goals**: 具体的な達成目標。
3. **Permissions**: 許可されている操作と禁止されている操作。
4. **Workflow**: 標準的な作業手順。
5. **I/O Contract**: 入力形式と出力形式（IR を含む）。
